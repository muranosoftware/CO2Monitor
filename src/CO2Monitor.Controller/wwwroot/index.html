<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">
    <title>CO2 Monitor</title>

    <link href="vendor/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css">

    <link href="vendor/datatables/dataTables.bootstrap4.css" rel="stylesheet">

    <link href="css/sb-admin.css" rel="stylesheet">

    <script src="js/axios.min.js"></script>
</head>

<body id="page-top">

    <nav class="navbar navbar-expand navbar-dark bg-dark static-top">

        <a class="navbar-brand mr-1" href="index.html">CO2 Monitor</a>

        <button class="btn btn-link btn-sm text-white order-1 order-sm-0" id="sidebarToggle" href="#">
            <i class="fas fa-bars"></i>
        </button>

        <!-- Navbar -->
        <ul class="navbar-nav ml-auto ml-md-0"></ul>
    </nav>

    <div id="wrapper">

        <div id="content-wrapper">
            <div class="container-fluid">
                <!-- Breadcrumbs-->
                <ol class="breadcrumb">
                    <li class="breadcrumb-item">
                        <a href="#">Dashboard</a>
                    </li>
                    <li class="breadcrumb-item active">Overview</li>
                </ol>
                <div class="card mb-3">
                    <div class="card-header">
                        <i class="fas fa-table"></i>
                        Remote Sensors
                        <span>
                            <a class="btn btn-info" href="#" data-toggle="modal" data-target="#newRemoteModal">New</a>
                        </span>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-bordered" id="remoteTable" width="100%" cellspacing="0">
                                <thead>
                                    <tr>
                                        <th style="width: 15.0%">Name</th>
                                        <th style="width: 5.0%">Id</th>
                                        <th style="width: 5.00%"><div align="center"> Status </div></th>
                                        <th style="width: 50.00%">State</th>
                                        <th style="width: 20.00%">Address</th>
                                        <th style="width: 5.00%"></th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="card mb-3">
                    <div class="card-header">
                        <i class="fas fa-chart-area"></i>
                        Timers
                        <span>
                            <a class="btn btn-info" href="#" data-toggle="modal" data-target="#newTimerModal">New</a>
                        </span>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-bordered" id="timerTable" width="100%" cellspacing="0">
                                <thead>
                                    <tr>
                                        <th style="width: 40.00%">Name</th>
                                        <th style="width: 10.00%">Id</th>
                                        <th style="width: 40.00%">Time</th>
                                        <th style="width: 5.00%"></th>
                                        <th style="width: 5.00%"></th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="card mb-3">
                    <div class="card-header">
                        <i class="fas fa-table"></i>
                        Rules
                        <span>
                            <a onclick="newRuleModalButtonClicked(event)"  class="btn btn-info"  href="#" data-toggle="modal">New</a>
                        </span>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-bordered" id="ruleTable" width="100%" cellspacing="0">
                                <thead>
                                    <tr>
                                        <th style="width: 20.00%">Name</th>
                                        <th style="width: 5.00%">Id</th>
                                        <th style="width: 65.00%">Descr</th>
                                        <th style="width: 5.00%"></th>
                                        <th style="width: 5.00%"></th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="card mb-3">
                    <div class="card-header">
                        <i class="fas fa-table"></i>
                        System Log
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-bordered" id="logTable" width="100%" cellspacing="0">
                                <thead>
                                    <tr>
                                        <th>Time</th>
                                        <th>Level</th>
                                        <th>Message</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <!-- /.container-fluid -->
            <!-- Sticky Footer -->
            <footer class="sticky-footer">
                <div class="container my-auto">
                    <div class="copyright text-center my-auto">
                        <span>© 2019 Murano Software</span>
                    </div>
                </div>
            </footer>

        </div>
        <!-- /.content-wrapper -->

    </div>
    <!-- /#wrapper -->
    <!-- Scroll to Top Button-->
    <a class="scroll-to-top rounded" href="#page-top">
        <i class="fas fa-angle-up"></i>
    </a>


    <!--New Remote Modal-->
    <div class="modal fade" id="newRemoteModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">New Remote Sensor</h5>
                    <button class="close" type="button" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">×</span>
                    </button>
                </div>
                <div class="container">
                    <div class="card-body">
                        <form id="newRemoteForm">
                            <div class="form-group">
                                <div class="form-label-group">
                                    <input type="text" name="name" id="inputRemoteName" class="form-control" placeholder="Name" required="required" autofocus="autofocus">
                                    <label for="inputRemoteName">Name</label>
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="form-label-group">
                                    <input type="text" name="address" id="inputRemoteAddress" class="form-control" placeholder="Address" required="required">
                                    <label for="inputRemoteAddress">Address</label>
                                </div>
                            </div>
                            <div class="modal-header">
                                <h5 class="modal-title">Fields</h5>
                                <span>
                                    <a id="addFieldNewRemoteButton" class="btn btn-info">Add</a>
                                </span>
                            </div>
                            <div>
                                <table class="table table-bordered" id="newRemoteFieldTable" width="100%" cellspacing="0">
                                    <thead>
                                        <tr>
                                            <th style="width: 35.00%">Name </th>
                                            <th style="width: 15.00%">Type</th>
                                            <th style="width: 38.00%">Enum Values</th>
                                            <th style="width: 12.00%"></th>
                                        </tr>
                                    </thead>
                                    <tbody id="newRemoteFieldTableBody"></tbody>
                                </table>
                            </div>
                            <div class="modal-header">
                                <h5 class="modal-title">Actions</h5>
                                <span>
                                    <a id="addActionNewRemoteButton" class="btn btn-info">Add</a>
                                </span>
                            </div>
                            <div>
                                <table class="table table-bordered" id="newRemoteActionTable" width="100%" cellspacing="0">
                                    <thead>
                                        <tr>
                                            <th style="width: 35.00%">Path</th>
                                            <th style="width: 15.00%">Argument Type</th>
                                            <th style="width: 38.00%">Argument Enum Values</th>
                                            <th style="width: 12.00%"></th>
                                        </tr>
                                    </thead>
                                    <tbody id="newRemoteActionTableBody"></tbody>
                                </table>
                            </div>
                            <div class="modal-header">
                                <h5 class="modal-title">Extensions</h5>
                                <span>
                                    <a id="addExtensionNewRemoteButton" class="btn btn-info">Add</a>
                                </span>
                            </div>
                            <div>
                                <table class="table table-bordered" id="newRemoteExtensionTable" width="100%" cellspacing="0">
                                    <thead>
                                        <tr>
                                            <th style="width: 44.00%">Extension</th>
                                            <th style="width: 44.00%">Parameter</th>
                                            <th style="width: 12.00%"></th>
                                        </tr>
                                    </thead>
                                    <tbody id="newRemoteExtensionTableBody"></tbody>
                                </table>
                            </div>
                        </form>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" type="button" data-dismiss="modal">Cancel</button>
                    <a id="createNewRemoteButton" class="btn btn-info">Create</a>
                </div>
            </div>
        </div>
    </div>


    <!--New Timer Modal-->
    <div class="modal fade" id="newTimerModal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">New Timer</h5>
                    <button class="close" type="button" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">×</span>
                    </button>
                </div>
                <div class="container">
                    <div class="card-body">
                        <form id="newTimerForm">
                            <div class="form-group">
                                <div class="form-label-group">
                                    <input type="text" name="name" id="inputTimerName" class="form-control" placeholder="Name" required="required" autofocus="autofocus">
                                    <label for="inputTimerName">Name</label>
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="form-label-group">
                                    <input type="text" name="time" id="inputTimerTime" class="form-control" placeholder="Time" required="required">
                                    <label for="inputTimerTime">Alarm time (hh:mm:ss)</label>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" type="button" data-dismiss="modal">Cancel</button>
                    <a id="createNewTimerButton" class="btn btn-info">Create</a>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="editTimerModal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Timer</h5>
                    <button class="close" type="button" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">×</span>
                    </button>
                </div>
                <div class="container">
                    <div class="card-body">
                        <form id="editTimerForm">
                            <div class="form-group">
                                <div class="form-label-group">
                                    <input type="text" name="name" id="inputTimerEditedName" class="form-control" placeholder="Name" required="required" autofocus="autofocus">
                                    <label for="inputTimerEditedName">Name</label>
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="form-label-group">
                                    <input type="text" name="time" id="inputTimerEditedTime" class="form-control" placeholder="Time" required="required">
                                    <label for="inputTimerEditedTime">Alarm time (hh:mm:ss)</label>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" type="button" data-dismiss="modal">Cancel</button>
                    <a id="saveTimerChanchedButton" class="btn btn-info">Save</a>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="newRuleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">New/Edit Rule</h5>
                    <button class="close" type="button" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">×</span>
                    </button>
                </div>
                <div class="container">
                    <div class="card-body">
                        <form id="newRuleForm">
                            <div class="form-group">
                                <label for="inputRuleName">Rule Name</label>
                                <input name="Name" id="inputRuleName" class="form-control">
                            </div>
                            <div class="form-group">
                                <label for="selectSourceDeviceId">Event Source Device</label>
                                <select name="SourceDeviceId" id="selectSourceDeviceId" class="form-control"></select>
                            </div>
                            <div class="form-group">
                                <label for="selectEvent">Event</label>
                                <select name="Event" id="selectEvent" class="form-control"></select>
                            </div>
                            <div class="form-group">
                                <label for="selectTargetDeviceId">Target Device</label>
                                <select name="targetDeviceId" id="selectTargetDeviceId" class="form-control"></select>
                            </div>
                            <div class="form-group">
                                <label for="selectAction">Action</label>
                                <select name="Action" id="selectAction" class="form-control"></select>
                            </div>
                            <div class="form-group">
                                <label for="selectArgumentSoource">Action Argument Source</label>
                                <select name="argumentSource" id="selectArgumentSource" onchange="selectArgumentSourceOnChange(event)" class="form-control">
                                    <option value="EventData">EventData</option>
                                    <option value="Constant">Constant</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="selectAction">Constant</label>
                                <input name="Value" id="inputValue" class="form-control" input disabled />
                            </div>
                            <div class="modal-header">
                                <h5 class="modal-title">Conditions</h5>
                                <span>
                                    <a id="addRuleConditionButton" class="btn btn-info">Add</a>
                                </span>
                            </div>

                            <div>
                                <table class="table table-bordered" id="newRuleConditionTable" width="100%" cellspacing="0">
                                    <thead>
                                        <tr>
                                            <th style="width: 25.00%">Device</th>
                                            <th style="width: 25.00%">Field</th>
                                            <th style="width: 15.00%"></th>
                                            <th style="width: 25.00%">Value</th>
                                            <th style="width: 10.00%"></th>
                                        </tr>
                                    </thead>
                                    <tbody id="newRuleConditionTableBody"></tbody>
                                </table>
                            </div>
                        </form>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" type="button" data-dismiss="modal">Cancel</button>
                    <a id="createNewRuleButton" class="btn btn-info">Create</a>
                </div>
            </div>
        </div>
    </div>
    <!-- Bootstrap core JavaScript-->
    <script src="vendor/jquery/jquery.min.js"></script>
    <script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

    <!-- Core plugin JavaScript-->
    <script src="vendor/jquery-easing/jquery.easing.min.js"></script>

    <!-- Page level plugin JavaScript-->
    <script src="vendor/chart.js/Chart.min.js"></script>
    <script src="vendor/datatables/jquery.dataTables.js"></script>
    <script src="vendor/datatables/dataTables.bootstrap4.js"></script>

    <!-- Custom scripts for all pages-->
    <script src="js/sb-admin.min.js"></script>

    <script src="js/signalr/signalr.min.js"></script>

    <script src="js/co2monitor-api.js"></script>
    <script>
    function deleteDeviceClicked(event) {
        var device = jQuery.data(event.srcElement.closest("tr"), "data");

        if (window.confirm(`Do you really want to delete device [${device.name}:${device.id}]?`)) {
            deleteDevice(device.id, () => {
                fillTimerTable();
                fillRemoteTable();
            });
        }
    };


    function fillRemoteTable() {
        getRemote((remote) => {
            for (let i in remote) {
                r = remote[i];
                r.del = '<div align="center"><button class="btn btn-danger" onclick="deleteDeviceClicked(event)">Del</button></div>';
                if (r.status == "Ok") {
                    r.statusIcon = '<div align="center"><img src="img/ok-64.png" alt="NotAccessible" width="32"></div>';
                } else {
                        r.statusIcon = '<div align="center"><img src="img/not-accessible.png" alt="NotAccessible" width="32"></div>';
                }
            }
            fillTable("remoteTable", remote, ["name", "id", "statusIcon", "state", "address", "del"]);
        });
    }

    function showEditTimerModal(event) {
        var timer = jQuery.data(event.srcElement.closest("tr"), "data");
        $("#editTimerForm").data("data", timer);
        document.getElementById("inputTimerEditedName").value = timer.name;
        document.getElementById("inputTimerEditedTime").value = timer.alarmTime;
        $('#editTimerModal').modal('show');
    }

    function fillTimerTable() {
        getTimers((timers) => {
            for (let i in timers) {
                t = timers[i];
                t.del = `<div align="center"><button class="btn btn-danger" onclick="deleteDeviceClicked(event)">Del</button></div>`;
                t.edit = `<div align="center"><button class="btn btn-info" onclick="showEditTimerModal(event)">Edit</button></div>`;
            }
            fillTable("timerTable", timers, ["name", "id", "alarmTime", "edit", "del"]);
        });
    }

    
    function newRuleModalButtonClicked(event) {
        var form = document.getElementById("newRuleForm");
        jQuery.data(form, "command", "new");
        jQuery.data(form, "rule", {});

        document.getElementById("createNewRuleButton").innerHTML = "Create";

        $('#newRuleModal').modal('show');
    }

    function showEditRuleModal(event) {
         var rule = jQuery.data(event.srcElement.closest("tr"), "data");

        var form = document.getElementById("newRuleForm");
        jQuery.data(form, "command", "edit");
        jQuery.data(form, "rule", rule);

        document.getElementById("createNewRuleButton").innerHTML = "Save";


        $('#newRuleModal').modal('show');
    }

    function deleteRuleClicked(event) {
        var rule = jQuery.data(event.srcElement.closest("tr"), "data");
        if (window.confirm(`Do you really want to delete rule [${rule.name}:${rule.id}]?`)) {
            deleteRule(rule.id, () => {
                fillRuleTable();
            });
        }
    };

    function fillRuleTable() {
        getRules((rules) => {
            for (let i in rules) {
                r = rules[i];
                r.desc = `Src: { Id = ${r.sourceDeviceId}, Event = "${r.event.name}}", Target: { Id = ${r.targetDeviceId}, Action="${r.action.path}", ArgumentSource="${r.argumentSource}" , ConstantArgument="${r.actionArgument}"}, Conditons="${JSON.stringify(r.conditions.map(c => c.deviceId + "." + c.field.name + " " + c.conditionType + " " + c.conditionArgument))}"`;
                r.edit = '<button class="btn btn-info" onclick="showEditRuleModal(event)">Edit</button>';
                r.del = '<button class="btn btn-danger" onclick="deleteRuleClicked(event)">Del</button>';
            }
            fillTable("ruleTable", rules, ["name", "id", "desc", "edit", "del"]);
        });
    }

    function fillLogTable() {
        getLog((records) => {
            var prev = 0;   
            var tableRecords = [];
            for (let i in records) {
                r = records[i];
                t = new Date(r.time);
                r.formatTime = t.toLocaleTimeString("ru-RU"); 
                if (r.logLevel == "Error") {
                    r.level = '<b>Error</b>';
                } else {
                    r.level = r.logLevel.substring(0, 4);            
                }

                var cur = 3600 * t.getHours() + 60 * t.getMinutes() + t.getSeconds();
                if (cur > prev) {
                    tableRecords.push({ formatTime: `<b> ${t.toISOString().substring(0,10).replace(/-/g, '.')} </b>`, level: "", message: "" });
                }
                prev = cur;

                tableRecords.push(r);
            }
            fillTable("logTable", tableRecords, ["formatTime", "level", "message"]);
        });
    }

    $("#newTimerModal").on("shown.bs.modal", () => {
        getDevices((devices) => {
            var id = 1;
            if (devices.length > 0) {
                id = Math.max.apply(Math, devices.map(d => d.id)) + 1;
            }

            inputTimerName = document.getElementById("inputTimerName");
            inputTimerName.value = "Timer" + id;
        });
    });

    var newTimerBtn = document.getElementById("createNewTimerButton");
    newTimerBtn.onclick = function () {
        timerData = serializedArrToObj($("#newTimerForm").serializeArray());
        if (!checkTimeFormat(timerData.time))
            return;

        if (isEmptyOrSpaces(timerData.name)) {
            window.alert("Timer Name must be not empty!");
            return;
        }

        createTimer(timerData.name, timerData.time, () => {
            $('#newTimerModal').modal('hide');
            fillTimerTable();
        });
    };

    var saveTimerChanchedBtn = document.getElementById("saveTimerChanchedButton");
    saveTimerChanchedBtn.onclick = function () {

        timer = $("#editTimerForm").data("data");

        timerData = serializedArrToObj($("#editTimerForm").serializeArray());
        if (!checkTimeFormat(timerData.time))
            return;

        if (isEmptyOrSpaces(timerData.name)) {
            window.alert("Timer Name must be not empty!");
            return;
        }

        patchTimer(timer.id, timerData.name, timerData.time, () => {
            $('#editTimerModal').modal('hide');
            fillTimerTable();
        });
    };

    function deleteRowFromTableClick(event) {
        var body = event.srcElement.closest("tbody");
        var row = event.srcElement.closest("tr");
        body.removeChild(row);
    }


    function enableEnumValuesInput(event) {
        var typeSelect = event.srcElement;
        typeSelect.value

        var input = typeSelect.closest("tr").getElementsByTagName("input")[1];
        if (typeSelect.value == "Enum") {
            input.disabled = false;
        } else {
            input.disabled = true;
            input.value = null;
        }
    }

    var addActionBtn = document.getElementById("addActionNewRemoteButton");
    addActionBtn.onclick = function () {
        var table = document.getElementById("newRemoteActionTable");
        var tbody = table.getElementsByTagName("tbody")[0];

        var tr = createTr(
            createInput("form-control"),
            createSelect(["Void", "Float", "String", "Enum"], x => x, enableEnumValuesInput, "form-control"),
            createInput("form-control", true),
            createButton("Del", deleteRowFromTableClick, "btn btn-danger"));
        tbody.appendChild(tr);
    };

    var addFieldBtn = document.getElementById("addFieldNewRemoteButton");
    addFieldBtn.onclick = function () {
        var table = document.getElementById("newRemoteFieldTable");
        var tbody = table.getElementsByTagName("tbody")[0];

        var tr = createTr(
            createInput("form-control"),
            createSelect(["Float", "Time", "String", "Enum"], (x) => x, enableEnumValuesInput, "form-control"),
            createInput("form-control", true),
            createButton("Del", deleteRowFromTableClick, "btn btn-danger"));


        tbody.appendChild(tr);
    };


    function selectArgumentSourceOnChange() {
        slct = document.getElementById("selectArgumentSource");
        if (slct.value == "Constant") {
            document.getElementById("inputValue").disabled = false;
        } else {
            document.getElementById("inputValue").disabled = true;
        }
    }

    var addExtensionNewRemoteBtn = document.getElementById("addExtensionNewRemoteButton");
    addExtensionNewRemoteBtn.onclick = function () {
        getExtensionTypes(types => {
            var tbody = document.getElementById("newRemoteExtensionTableBody");
            tbody.appendChild(
                createTr(
                    createSelect(types, (x) => x, null, "form-control"),
                    createInput("form-control"),
                    createButton("Del", deleteRowFromTableClick, "btn btn-danger")
                )
            );
        });
    }

    var createRemoteBtn = document.getElementById("createNewRemoteButton");
    createRemoteBtn.onclick = function () {
        var info = serializedArrToObj($("#newRemoteForm").serializeArray());
        console.debug(info);
        var actions = [];
        var fields = [];
        var extensions = [];

        $("#newRemoteActionTableBody").find("tr").each(function (i, row) {
            var tds = row.getElementsByTagName("td");

            var type = tds[1].getElementsByTagName("select")[0].value;
            var vals = null;
            if (type == "Enum") {
                vals = tds[2].getElementsByTagName("input")[0].value.split(",").map(x => x.trim());
            }

            actions.push({
                path: tds[0].getElementsByTagName("input")[0].value.trim(),
                argument: {
                    type: type,
                    enumValues: vals
                }
            });
        });

        $("#newRemoteFieldTableBody").find("tr").each(function (i, row) {
            var tds = row.getElementsByTagName("td");

            var type = tds[1].getElementsByTagName("select")[0].value;
            var vals = null;
            if (type == "Enum") {
                vals = tds[2].getElementsByTagName("input")[0].value.split(",").map(x => x.trim());
            }

            fields.push({
                name: tds[0].getElementsByTagName("input")[0].value.trim(),
                type: {
                    type: type,
                    enumValues: vals
                }
            });
        });

        $("#newRemoteExtensionTableBody").find("tr").each(function (i, row) {
            var tds = row.getElementsByTagName("td");

            extensions.push({
                type: tds[0].getElementsByTagName("select")[0].value,
                parameter: tds[1].getElementsByTagName("input")[0].value
            });
        });

        info.name = info.name.trim();
        info.address = info.address.trim();
        while (info.address[info.address - 1] == "/")
            info.address = info.address.slice(0, -1);
            
        createRemote(info.name, info.address , fields, actions, (remote) => {

            for (let i in extensions) {
                createExtension(remote.id, extensions[i].type, extensions[i].parameter, () => { });
            }
            fillRemoteTable();

            $('#newRemoteModal').modal('hide');
        });
    };

    function ruleConditionDeviceSelectOnChange(event) {
        var deviceSelect = event.srcElement;
        var device = jQuery.data(deviceSelect.options[deviceSelect.selectedIndex], "data");

        var tr = deviceSelect.closest("tr");
        var oldFieldSelect = tr.getElementsByTagName("select")[1];
        var td = tr.getElementsByTagName("select")[1].closest("td");
        td.removeChild(oldFieldSelect);

        td.appendChild(createSelect(device.info.fields, x => x.name, null, "form-control"));
    }


    $("#newRuleModal").on("shown.bs.modal", () => {
        getRules((rules) => {
            var id = 1;
            if (rules.length > 0) {
                id = Math.max.apply(Math, rules.map(d => d.id)) + 1;
            }
            inputRuleName = document.getElementById("inputRuleName");
            inputRuleName.value = "Rule" + id;
        });

        
        getDevices((devices) => {

            var form = document.getElementById("newRuleForm");
            var command = jQuery.data(form, "command");
            var rule = jQuery.data(form, "rule");

            var selectTargetDeviceId = document.getElementById("selectTargetDeviceId");
            var selectAction = document.getElementById("selectAction");

            $("#selectSourceDeviceId").empty();
            $("#selectTargetDeviceId").empty();
            document.getElementById("newRuleConditionTableBody").innerHTML = "";

            var selectSourceDeviceId = document.getElementById("selectSourceDeviceId");
            var selectEvent = document.getElementById("selectEvent");

            selectSourceDeviceId.onchange = function () {
                $("#selectEvent").empty();
                events = devices.find(d => d.id == selectSourceDeviceId.value).info.events;

                for (let i in events) {
                    var e = events[i];
                    var opt = document.createElement("option");
                    opt.innerHTML = e.name;
                    opt.value = e.name;
                    jQuery.data(opt, "data", e);
                    selectEvent.appendChild(opt);
                }
            };

            selectTargetDeviceId.onchange = function () {
                $("#selectAction").empty();
                actions = devices.find(d => d.id == selectTargetDeviceId.value).info.actions;

                for (let i in actions) {
                    var a = actions[i];
                    var opt = document.createElement("option");
                    opt.innerHTML = a.path;
                    opt.value = a.path;
                    jQuery.data(opt, "data", a);
                    selectAction.appendChild(opt);
                }
            };

            for (let i in devices) {
                let d = devices[i];
                if (d.info.events.length > 0) {
                    var opt = document.createElement("option");
                    opt.innerHTML = d.name + ":" + d.id;
                    opt.value = d.id;
                    selectSourceDeviceId.appendChild(opt);
                }

                if (d.info.actions.length > 0) {
                    var opt = document.createElement("option");
                    opt.innerHTML = d.name + ":" + d.id;
                    opt.value = d.id;
                    selectTargetDeviceId.appendChild(opt);
                }
            }

            createNewRuleButton.onclick = function () {
                var conditions = [];

                $("#newRuleConditionTableBody").find("tr").each(function (i, row) {
                    var tds = row.getElementsByTagName("td");

                    var deviceSelect = tds[0].getElementsByTagName("select")[0];
                    var device = jQuery.data(deviceSelect.options[deviceSelect.selectedIndex], "data");
                    var fieldSelect = tds[1].getElementsByTagName("select")[0];
                    var field = jQuery.data(fieldSelect.options[fieldSelect.selectedIndex], "data");
                    var condTypeSelect = tds[2].getElementsByTagName("select")[0];
                    condType = jQuery.data(condTypeSelect.options[condTypeSelect.selectedIndex], "data").cond;

                    conditions.push({
                        deviceId: device.id,
                        field: field,
                        conditionType: condType,
                        conditionArgument: tds[3].getElementsByTagName("input")[0].value
                    });
                });

                rule.name = document.getElementById("inputRuleName").value;
                rule.sourceDeviceId = selectSourceDeviceId.value;
                rule.event = jQuery.data(selectEvent.options[selectEvent.selectedIndex], "data");
                rule.targetDeviceId = selectTargetDeviceId.value;
                rule.action = jQuery.data(selectAction.options[selectAction.selectedIndex], "data");
                rule.actionArgument = document.getElementById("inputValue").value;
                rule.argumentSource = document.getElementById("selectArgumentSource").value;
                rule.conditions = conditions;
            
                if (command == "new") {
                    createRule(rule, () => {
                        $("#newRuleModal").modal("hide");
                        fillRuleTable();
                    });
                } else {
                    editRule(rule, () => {
                        $("#newRuleModal").modal("hide");
                        fillRuleTable();
                    });
                }
            };


            addRuleConditionBtn = document.getElementById("addRuleConditionButton");
            addRuleConditionBtn.onclick = () => {
                var table = document.getElementById("newRuleConditionTable");
                var tbody = table.getElementsByTagName("tbody")[0];
                var signs = [{ cond: "Equal", sign: "==" },
                { cond: "NotEqual", sign: "!=" },
                { cond: "GreaterThan", sign: ">" },
                { cond: "LessTahn", sign: "<" },
                { cond: "GreaterThanOrEqual", sign: ">=" },
                { cond: "LessThanOrEqual", sign: "<=" }];
                var deviceSelect = createSelect(devices, x => x.name + "." + x.id, ruleConditionDeviceSelectOnChange, "form-control");

                tr = createTr(
                    createSelect(devices, x => x.name + "." + x.id, ruleConditionDeviceSelectOnChange, "form-control"),
                    createSelect(devices[0].info.fields, x => x.name, null, "form-control"),
                    createSelect(signs, x => x.sign, null, "form-control"),
                    createInput("form-control"),
                    createButton("Del", deleteRowFromTableClick, "btn btn-danger"));
                tbody.appendChild(tr);

            };

            
            selectSourceDeviceId.onchange();
            selectTargetDeviceId.onchange();

            if (rule.name)
                inputRuleName.value = rule.name;

            if (rule.sourceDeviceId) {
                selectSourceDeviceId.value = rule.sourceDeviceId;
                selectSourceDeviceId.onchange();
            }
            
            if (rule.event)
                selectEvent.value = rule.event.name;

            if (rule.targetDeviceId) {
                selectTargetDeviceId.value = rule.targetDeviceId;
                selectTargetDeviceId.onchange();
            }

            if (rule.action)
                selectAction.value = rule.action.path;

            if (rule.actionArgument)
                document.getElementById("inputValue").value = rule.actionArgument;

            if (rule.argumentSource) {
                document.getElementById("selectArgumentSource").value = rule.argumentSource;
                selectArgumentSourceOnChange();
            }
            if (rule.conditions)
            {
                for (let i in rule.conditions)
                    addRuleConditionBtn.onclick();

                $("#newRuleConditionTableBody").find("tr").each(function (i, row) {
                    var tds = row.getElementsByTagName("td");

                    cond = rule.conditions[i];

                    var deviceSelect = tds[0].getElementsByTagName("select")[0];

                    for (let j = 0; j < deviceSelect.options.length; j++)
                    {
                        var opt = deviceSelect.options[j];
                        if (cond.deviceId == jQuery.data(opt, "data").id)
                        {
                            opt.selected = true;
                            ruleConditionDeviceSelectOnChange({ srcElement: deviceSelect });
                            break;
                        }
                    }

                    var fieldSelect = tds[1].getElementsByTagName("select")[0];

                    for (let j = 0; j < fieldSelect.options.length; j++)
                    {
                        var opt = fieldSelect.options[j];
                        if (cond.field.name == jQuery.data(opt, "data").name)
                        {
                            opt.selected = true;
                            break;
                        }
                    }
                    
                    var condTypeSelect = tds[2].getElementsByTagName("select")[0];

                    for (let j = 0; j < condTypeSelect.options.length; j++)
                    {
                        var opt = condTypeSelect.options[j];
                        if (cond.conditionType == jQuery.data(opt, "data").cond)
                        {
                            opt.selected = true;
                            break;
                        }
                    }

                    tds[3].getElementsByTagName("input")[0].value = cond.conditionArgument;

                });

            }

        });
    });

    function updateTables() {
        fillTimerTable();
        fillRemoteTable();
        fillRuleTable();
        fillLogTable();
    }

    updateTables();

    var connection = new signalR.HubConnectionBuilder()
        .withUrl("/events")
        .configureLogging(signalR.LogLevel.Information)
        .build();

    connection.on("ServerEvent", function (message) {
        console.log(`ServerEvent: ${message}`);
        updateTables();
    });



    async function start() {
        try {
            await connection.start();
            console.log("connected");
        } catch (err) {
            console.log(err);
            setTimeout(() => start(), 5000);
        }
    };

    connection.onclose(async () => {
        await start();
    });

    connection.start().then(() => {
        console.log("connected");
    });



    </script>
</body>

</html>
