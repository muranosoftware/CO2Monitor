<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>CO2 Monitor</title>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.3/Chart.min.js"></script>
    <style>
        form {
            border: 1px solid black;
            padding: 10px;
        }
    </style>
</head>
<body>
    <h1>CO2 Monitor</h1>

    <form>
        <h4>CO2 Sensor </h4>
        <table>
            <tr>
                <td>Address:</td>
                <td>
                    <input type="text" id="driverInput" />
                </td>
                <td>
                    <input type="button" id="driverButton" value="Set" />
                </td>
            </tr>
            <tr>
                <td>Polling Rate (s):</td>
                <td>
                    <input type="text" id="rateInput" />
                </td>
                <td>
                    <input type="button" id="rateButton" value="Set" />
                </td>
            </tr>
            <tr>
                <td>Normal CO2 Level:</td>
                <td>
                    <input type="text" id="normalInput" />
                </td>
                <td>
                    <input type="button" id="normalButton" value="Set" />
                </td>
            </tr>
            <tr>
                <td>Mid CO2 Level:</td>
                <td>
                    <input type="text" id="midInput" />
                </td>
                <td>
                    <input type="button" id="midButton" value="Set" />
                </td>
            </tr>
            <tr>
                <td>High CO2 Level:</td>
                <td>
                    <input type="text" id="highInput" />
                </td>
                <td>
                    <input type="button" id="highButton" value="Set" />
                </td>
            </tr>
        </table>
    </form>
    <form>
        <h4>Fan (Led)</h4>
        <table>
            <tr>
                <td>Address:</td>
                <td>
                    <input type="text" id="fanInput" />
                </td>
                <td>
                    <input type="button" id="fanButton" value="Set" />
                </td>
            </tr>
        </table>
    </form>

    <canvas id="plot"></canvas>

    <script>
        var api = {
            "driver": "/api/CO2Monitor/sensorAddress",
            "rate": "/api/CO2Monitor/pollingRate",
            "normal": "api/CO2Monitor/level/normal",
            "mid": "api/CO2Monitor/level/mid",
            "high": "api/CO2Monitor/level/high",
            "fan" : "api/CO2Monitor/fanAddress"
        };

        for (let key in api) {
            let url = api[key];
            let = inputId = key + "Input";
            let input = document.getElementById(inputId);
            axios.get(url)
                .then(function (response) {
                    input.value = response.data;
                })
                .catch(function (error) {
                    console.error(error);
                });
            let butId = key + "Button";
            but = document.getElementById(butId);
            but.onclick = function () {
                axios.put(url, null, {
                    params: { value: input.value }
                })
                    .then(function (response) {
                    })
                    .catch(function (error) {
                        window.alert(error.response.data);

                        axios.get(url)
                            .then(function (response) {
                                input.value = response.data;
                            })
                            .catch(function (error) {
                                console.error(error);
                            });
                    });
            };
        }
        /*------------------ plot ----------------------*/

        function create_plot(data) {

            var ctx = document.getElementById('plot').getContext('2d');
            var chart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: 'CO2 ',
                        //backgroundColor: 'rgb(255, 99, 132)',
                        borderColor: 'rgb(255, 99, 132)',
                        data: data
                    }]
                },
                options: {
                    title: {
                        display: false,
                        text: 'Chart'
                    },
                    scales: {
                        xAxes: [{
                            type: 'time',
                            distribution: 'series',
                            ticks: {
                                source: 'data',
                                autoSkip: true
                            }
                        }],
                        yAxes: [{
                            position: 'left',
                            gridLines: {
                                zeroLineColor: "rgba(0,255,0,1)"
                            },
                            scaleLabel: {
                                display: true,
                                labelString: 'y axis'
                            }
                        }]
                    }
                }
            });
        }

        today = new Date();
        today.setHours(0, 0, 0, 0);

        axios.get("/api/CO2Stat", {
            params: { from: today, to: new Date() }
        })
            .then(function (response) {

                data = response.data.map(m => {
                    var p = {};
                    p.x = m.time;
                    p.y = m.cO2;
                    return p;
                });
                create_plot(data);
            })
            .catch(function (error) {
                window.alert(error.response.data);

            });


    </script>
</body>

</html>